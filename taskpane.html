<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>ChatGPT Excel Add-in</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 400px;
        }
        input, textarea, button {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
        }
        button:hover {
            background-color: #106ebe;
        }
        .response {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            min-height: 100px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ChatGPT for Excel</h2>
        
        <div>
            <h3>API Key</h3>
            <input type="password" id="apiKey" placeholder="Enter OpenAI API Key"/>
            <button onclick="saveApiKey()">Save Key</button>
        </div>
        
        <div>
            <h3>Chat</h3>
            <textarea id="prompt" placeholder="Enter your message..." rows="4"></textarea>
            <button onclick="sendToChatGPT()">Send to ChatGPT</button>
        </div>
        
        <div class="response" id="response">
            Response will appear here...
        </div>
        
        <div>
            <h3>Excel Tools</h3>
            <button onclick="getSelectedData()">Get Selected Data</button>
            <button onclick="insertFormula()">Insert Formula</button>
        </div>
    </div>

    <script>
        let apiKey = '';
        
        function saveApiKey() {
            apiKey = document.getElementById('apiKey').value;
            localStorage.setItem('chatgpt_api_key', apiKey);
            alert('API Key saved!');
        }
        
        function loadApiKey() {
            const savedKey = localStorage.getItem('chatgpt_api_key');
            if (savedKey) {
                apiKey = savedKey;
                document.getElementById('apiKey').value = '••••••••••••••••';
            }
        }
        
        async function sendToChatGPT() {
            if (!apiKey) {
                alert('Please enter API Key first');
                return;
            }
            
            const prompt = document.getElementById('prompt').value;
            if (!prompt) {
                alert('Please enter a message');
                return;
            }
            
            document.getElementById('response').innerHTML = 'Loading...';
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 500
                    })
                });
                
                const data = await response.json();
                document.getElementById('response').innerHTML = 
                    data.choices[0].message.content;
                    
            } catch (error) {
                document.getElementById('response').innerHTML = 
                    'Error: ' + error.message;
            }
        }
        
        async function getSelectedData() {
            try {
                await Excel.run(async (context) => {
                    const range = context.workbook.getSelectedRange();
                    range.load('values');
                    await context.sync();
                    
                    const dataText = JSON.stringify(range.values, null, 2);
                    document.getElementById('prompt').value = 
                        `Analyze this Excel data:\n${dataText}`;
                });
            } catch (error) {
                alert('Error getting data: ' + error.toString());
            }
        }
        
        function insertFormula() {
            const formula = document.getElementById('response').innerText;
            if (formula) {
                Excel.run(async (context) => {
                    const range = context.workbook.getSelectedRange();
                    range.formulas = [[formula]];
                    await context.sync();
                });
            }
        }
        
        // Load saved API key on start
        Office.onReady(() => {
            loadApiKey();
        });
    </script>
</body>
</html>
